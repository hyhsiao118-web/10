<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬éƒ½æ—…ç¨‹ - ç®¡ç†èˆ‡å”ä½œç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .bg-gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .timeline-dot { width: 12px; height: 12px; border-radius: 50%; background-color: #6366f1; border: 2px solid #e0e7ff; z-index: 10; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK (Modular) -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query } from 'firebase/firestore';
        window.FCloud = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // åœ–ç¤ºçµ„ä»¶
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                MapPin: "ğŸ“", Calendar: "ğŸ“…", ShoppingBag: "ğŸ›ï¸", Info: "ğŸ“",
                Check: "âœ…", Plus: "â•", Trash: "ğŸ—‘ï¸", Box: "ğŸ“¦",
                User: "ğŸ‘¤", Clock: "â°", Rocket: "ğŸš€", Shield: "ğŸ”’", Save: "ğŸ’¾"
            };
            return <span className={className} style={{fontSize: `${size}px`}}>{icons[name] || "â€¢"}</span>;
        };

        const App = () => {
            const [view, setView] = useState('user'); // 'user' or 'admin'
            const [activeDay, setActiveDay] = useState(1);
            
            // è³‡æ–™ç‹€æ…‹
            const [mainItinerary, setMainItinerary] = useState({}); // ä¸»è¡Œç¨‹
            const [orders, setOrders] = useState([]); // ä½¿ç”¨è€…å»ºè­°
            const [suggestionForm, setSuggestionForm] = useState({ title: '', note: '' });
            const [adminEditForm, setAdminEditForm] = useState({ time: '', activity: '', note: '' });
            
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'trip-master-v1';

            // --- Firebase åˆå§‹åŒ–èˆ‡å¯¦æ™‚åŒæ­¥ ---
            useEffect(() => {
                const init = async () => {
                    if (!window.FCloud) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, onSnapshot, collection } = window.FCloud;
                    
                    try {
                        const config = JSON.parse(__firebase_config);
                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const db = getFirestore(app);

                        // ç™»å…¥
                        const authRes = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token)
                            ? await signInWithCustomToken(auth, __initial_auth_token)
                            : await signInAnonymously(auth);
                        setUser(authRes.user);

                        // 1. ç›£è½ä¸»è¡Œç¨‹ (6æ®µè·¯å¾‘ç¬¦åˆè¦å‰‡)
                        const mainRef = doc(db, 'artifacts', appId, 'public', 'data', 'itinerary_config', 'master_plan');
                        const unsubMain = onSnapshot(mainRef, (snap) => {
                            if (snap.exists()) setMainItinerary(snap.data().data || {});
                        });

                        // 2. ç›£è½å»ºè­°è¨‚å–® (5æ®µè·¯å¾‘)
                        const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'suggestions');
                        const unsubOrders = onSnapshot(ordersRef, (snap) => {
                            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            data.sort((a, b) => b.timestamp - a.timestamp);
                            setOrders(data);
                            setIsLoading(false);
                        });

                        return () => { unsubMain(); unsubOrders(); };
                    } catch (e) { console.error(e); }
                };
                
                const timer = setInterval(() => { if(window.FCloud) { init(); clearInterval(timer); } }, 100);
            }, [appId]);

            // --- æ ¸å¿ƒï¼šç®¡ç†å“¡ç·¨è¼¯ä¸»è¡Œç¨‹åŠŸèƒ½ ---
            const updateMasterPlan = async (newPlan) => {
                const { getFirestore, doc, setDoc } = window.FCloud;
                const db = getFirestore();
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'itinerary_config', 'master_plan');
                await setDoc(docRef, { data: newPlan, lastUpdated: Date.now() });
            };

            const handleAdminAdd = (e) => {
                e.preventDefault();
                const dayItems = mainItinerary[activeDay] || [];
                const newItem = { ...adminEditForm, id: Date.now().toString() };
                const nextPlan = { ...mainItinerary, [activeDay]: [...dayItems, newItem] };
                setMainItinerary(nextPlan);
                updateMasterPlan(nextPlan);
                setAdminEditForm({ time: '', activity: '', note: '' });
            };

            const handleAdminDelete = (id) => {
                const dayItems = mainItinerary[activeDay] || [];
                const nextPlan = { ...mainItinerary, [activeDay]: dayItems.filter(item => item.id !== id) };
                setMainItinerary(nextPlan);
                updateMasterPlan(nextPlan);
            };

            // --- ä½¿ç”¨è€…æäº¤å»ºè­°åŠŸèƒ½ ---
            const handleSubmitSuggestion = async (e) => {
                e.preventDefault();
                if (!suggestionForm.title || !user) return;
                const { getFirestore, collection, addDoc } = window.FCloud;
                const db = getFirestore();
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'suggestions');

                await addDoc(colRef, {
                    day: activeDay,
                    title: suggestionForm.title,
                    note: suggestionForm.note,
                    userName: user.uid.substring(0, 5),
                    timestamp: Date.now()
                });
                setSuggestionForm({ title: '', note: '' });
                alert('âœ… æ‚¨çš„å»ºè­°å·²é€é”ç®¡ç†å“¡å¾Œå°ï¼');
            };

            // æ’åºä¸»è¡Œç¨‹æ™‚é–“
            const getMinutes = (t) => {
                const m = t?.match(/(\d{1,2})[:ï¼š](\d{1,2})/);
                return m ? parseInt(m[1]) * 60 + parseInt(m[2]) : 9999;
            };
            const sortedDayItinerary = useMemo(() => {
                return [...(mainItinerary[activeDay] || [])].sort((a, b) => getMinutes(a.time) - getMinutes(b.time));
            }, [activeDay, mainItinerary]);

            if (isLoading) return <div className="min-h-screen flex items-center justify-center text-slate-400 font-bold">è¼‰å…¥åŒæ­¥åœ°åœ–ä¸­...</div>;

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-gradient-header text-white p-6 shadow-xl sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <Icon name="Rocket" size={24} className="text-indigo-400" />
                                <div>
                                    <h1 className="text-xl font-bold tracking-tight">äº¬éƒ½ãƒ»å¤§é˜ªæ—…ç¨‹é›²ç«¯ä¸­å¿ƒ</h1>
                                    <p className="text-slate-400 text-[10px] uppercase font-black tracking-widest">Real-time Collaboration</p>
                                </div>
                            </div>
                            <div className="flex bg-slate-800 p-1 rounded-2xl">
                                <button onClick={() => setView('user')} className={`px-5 py-2 rounded-xl text-xs font-bold transition-all ${view === 'user' ? 'bg-white text-slate-900' : 'text-slate-500'}`}>å‰å°è¦–è§’</button>
                                <button onClick={() => setView('admin')} className={`px-5 py-2 rounded-xl text-xs font-bold transition-all ${view === 'admin' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500'}`}>ç®¡ç†å¾Œå°</button>
                            </div>
                        </div>
                    </header>

                    {/* Day Selector */}
                    <nav className="bg-white border-b sticky top-[88px] z-40 overflow-x-auto no-scrollbar">
                        <div className="max-w-6xl mx-auto flex px-6">
                            {[1,2,3,4,5,6,7].map(d => (
                                <button key={d} onClick={() => setActiveDay(d)} className={`flex-none px-6 py-4 text-sm font-black transition-all border-b-2 ${activeDay === d ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>Day {d}</button>
                            ))}
                        </div>
                    </nav>

                    {view === 'user' ? (
                        /* --- å‰å°ï¼šä½¿ç”¨è€…æŸ¥çœ‹è¡Œç¨‹ä¸¦æäº¤å»ºè­° --- */
                        <main className="flex-1 max-w-6xl mx-auto w-full p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 fade-in">
                            {/* å·¦ï¼šå³æ™‚ä¸»è¡Œç¨‹ */}
                            <div className="lg:col-span-7 space-y-6">
                                <section className="bg-white rounded-[2rem] p-8 card-shadow border border-slate-200">
                                    <h2 className="text-2xl font-black text-slate-800 mb-8 flex items-center gap-2">
                                        <Icon name="Calendar" className="text-indigo-600" /> ç•¶å‰ä¸»è¡Œç¨‹
                                    </h2>
                                    <div className="space-y-8 relative">
                                        {sortedDayItinerary.map((item, i) => (
                                            <div key={item.id} className="flex gap-4 relative">
                                                {i !== sortedDayItinerary.length - 1 && <div className="absolute left-[5px] top-6 w-[2px] h-full bg-slate-100"></div>}
                                                <div className="timeline-dot mt-1.5 flex-shrink-0"></div>
                                                <div className="flex-1 pb-2">
                                                    <div className="flex justify-between items-baseline">
                                                        <span className="text-xs font-black text-indigo-500 w-12">{item.time}</span>
                                                        <h4 className="flex-1 font-bold text-lg text-slate-800 ml-4">{item.activity}</h4>
                                                    </div>
                                                    {item.note && <p className="text-sm text-slate-500 mt-2 bg-slate-50 p-3 rounded-2xl border border-slate-100 inline-block ml-16">{item.note}</p>}
                                                </div>
                                            </div>
                                        ))}
                                        {sortedDayItinerary.length === 0 && (
                                            <div className="py-20 text-center text-slate-300 font-bold italic">
                                                ç®¡ç†å“¡å°šæœªç™¼ä½ˆé€™å¤©çš„è¡Œç¨‹ã€‚
                                            </div>
                                        )}
                                    </div>
                                </section>
                            </div>

                            {/* å³ï¼šå»ºè­°è¡¨å–® */}
                            <div className="lg:col-span-5">
                                <section className="bg-slate-900 rounded-[2rem] p-8 shadow-2xl sticky top-40 border border-white/5 text-white">
                                    <div className="flex items-center gap-2 mb-6">
                                        <Icon name="Box" size={20} className="text-indigo-400" />
                                        <h3 className="font-bold text-sm tracking-widest uppercase">æäº¤è®Šæ›´è¨‚å–®</h3>
                                    </div>
                                    <form onSubmit={handleSubmitSuggestion} className="space-y-5">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">å»ºè­°å…§å®¹ / æƒ³å»çš„åœ°æ–¹</label>
                                            <input 
                                                type="text" value={suggestionForm.title} onChange={e => setSuggestionForm({...suggestionForm, title: e.target.value})}
                                                className="w-full p-4 bg-slate-800 border-none rounded-2xl text-sm mt-1 focus:ring-2 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ—©é¤æ”¹å»éŒ¦å¸‚å ´" required
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">è©³ç´°èªªæ˜ (é¸å¡«)</label>
                                            <textarea 
                                                rows="3" value={suggestionForm.note} onChange={e => setSuggestionForm({...suggestionForm, note: e.target.value})}
                                                className="w-full p-4 bg-slate-800 border-none rounded-2xl text-sm mt-1 focus:ring-2 focus:ring-indigo-500" placeholder="ç‚ºä»€éº¼æƒ³æ”¹å‘¢ï¼Ÿ"
                                            ></textarea>
                                        </div>
                                        <button type="submit" className="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-500 active:scale-95 transition-all">é€å‡ºå»ºè­°</button>
                                    </form>
                                </section>
                            </div>
                        </main>
                    ) : (
                        /* --- å¾Œå°ï¼šç®¡ç†å“¡ç·¨è¼¯ä¸»è¡Œç¨‹ + æª¢è¦–å»ºè­° --- */
                        <main className="flex-1 max-w-6xl mx-auto w-full p-6 space-y-8 fade-in">
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                
                                {/* å·¦ï¼šä¸»å…§å®¹ç·¨è¼¯å™¨ (æ‚¨å¯ä»¥ç·¨è¼¯çœŸæ­£çš„è¡Œç¨‹) */}
                                <div className="lg:col-span-8 space-y-6">
                                    <section className="bg-white rounded-3xl p-8 border-2 border-indigo-100 card-shadow">
                                        <div className="flex justify-between items-center mb-8 border-b pb-4">
                                            <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                                <Icon name="Shield" className="text-indigo-600" /> ä¸»è¡Œç¨‹ç·¨è¼¯å™¨ (Day {activeDay})
                                            </h2>
                                            <span className="text-[10px] font-bold text-indigo-400 animate-pulse bg-indigo-50 px-3 py-1 rounded-full uppercase">å¯¦æ™‚é€£ç·šä¸­</span>
                                        </div>

                                        {/* è¡Œç¨‹åˆ—è¡¨ */}
                                        <div className="space-y-4 mb-8">
                                            {sortedDayItinerary.map(item => (
                                                <div key={item.id} className="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100 group">
                                                    <span className="text-xs font-black text-indigo-500 w-12">{item.time}</span>
                                                    <div className="flex-1">
                                                        <div className="font-bold text-slate-800">{item.activity}</div>
                                                        <div className="text-xs text-slate-400">{item.note}</div>
                                                    </div>
                                                    <button onClick={() => handleAdminDelete(item.id)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all p-2">
                                                        <Icon name="Trash" size={18} />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>

                                        {/* æ–°å¢ä¸»è¡Œç¨‹è¡¨å–® */}
                                        <form onSubmit={handleAdminAdd} className="bg-indigo-50/50 p-6 rounded-3xl border border-indigo-100 flex flex-wrap gap-4 items-end">
                                            <div className="flex-1 min-w-[120px]">
                                                <label className="text-[10px] font-black text-indigo-400 uppercase ml-1">æ™‚é–“</label>
                                                <input type="text" value={adminEditForm.time} onChange={e => setAdminEditForm({...adminEditForm, time: e.target.value})} placeholder="09:00" className="w-full mt-1 p-3 rounded-xl border-none text-sm" required />
                                            </div>
                                            <div className="flex-[2] min-w-[200px]">
                                                <label className="text-[10px] font-black text-indigo-400 uppercase ml-1">è¡Œç¨‹é»</label>
                                                <input type="text" value={adminEditForm.activity} onChange={e => setAdminEditForm({...adminEditForm, activity: e.target.value})} placeholder="åœ°é»æˆ–æ´»å‹•" className="w-full mt-1 p-3 rounded-xl border-none text-sm" required />
                                            </div>
                                            <div className="flex-[2] min-w-[200px]">
                                                <label className="text-[10px] font-black text-indigo-400 uppercase ml-1">å‚™è¨»</label>
                                                <input type="text" value={adminEditForm.note} onChange={e => setAdminEditForm({...adminEditForm, note: e.target.value})} placeholder="ç´°ç¯€..." className="w-full mt-1 p-3 rounded-xl border-none text-sm" />
                                            </div>
                                            <button type="submit" className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                                                <Icon name="Save" /> ç™¼ä½ˆ
                                            </button>
                                        </form>
                                    </section>
                                </div>

                                {/* å³ï¼šæª¢è¦–å¤§å®¶çš„å»ºè­° (è¨‚å–®æ¸…å–®) */}
                                <div className="lg:col-span-4">
                                    <section className="bg-white rounded-3xl p-8 border border-slate-200 card-shadow h-fit">
                                        <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                                            <Icon name="Box" className="text-indigo-400" /> ä½¿ç”¨è€…æäº¤æ¸…å–® ({orders.length})
                                        </h3>
                                        <div className="space-y-4 max-h-[600px] overflow-y-auto pr-2 no-scrollbar">
                                            {orders.map(order => (
                                                <div key={order.id} className="p-4 rounded-2xl bg-slate-50 border border-slate-100 fade-in">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <span className="text-[10px] font-black bg-white px-2 py-1 rounded-lg shadow-sm">Day {order.day}</span>
                                                        <span className="text-[9px] font-bold text-slate-400">USER-{order.userName}</span>
                                                    </div>
                                                    <div className="font-bold text-slate-700 text-sm">{order.title}</div>
                                                    <div className="text-xs text-slate-400 mt-1 italic">{order.note || 'ç„¡å‚™è¨»'}</div>
                                                    <div className="mt-3 flex justify-end">
                                                        <button 
                                                            onClick={async () => {
                                                                const { getFirestore, doc, deleteDoc } = window.FCloud;
                                                                await deleteDoc(doc(getFirestore(), 'artifacts', appId, 'public', 'data', 'suggestions', order.id));
                                                            }}
                                                            className="text-[10px] font-bold text-slate-300 hover:text-red-500 transition-all"
                                                        >å·²è®€/åˆªé™¤</button>
                                                    </div>
                                                </div>
                                            ))}
                                            {orders.length === 0 && <p className="text-center py-10 text-slate-300 font-bold italic">ç›®å‰æ²’æœ‰æ–°å»ºè­°</p>}
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </main>
                    )}

                    <footer className="bg-white border-t p-6 text-center text-slate-300 text-[10px] font-black uppercase tracking-[0.3em]">
                        Admin Master Control Center Â© 2026
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
