<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬éƒ½ãƒ»å¤§é˜ªå†¬æ—¥æ—… - å…±äº«å”ä½œç‰ˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-gradient-header { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
        .timeline-dot { width: 14px; height: 14px; border-radius: 50%; background-color: #6366f1; border: 3px solid #e0e7ff; z-index: 10; }
        .timeline-dot-custom { width: 14px; height: 14px; border-radius: 50%; background-color: #10b981; border: 3px solid #d1fae5; z-index: 10; }
        .chat-bubble { border-radius: 18px 18px 18px 2px; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sync-badge { position: fixed; bottom: 20px; right: 20px; z-index: 100; font-size: 10px; background: rgba(255,255,255,0.9); padding: 4px 12px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <div id="root">
        <div class="flex flex-col items-center justify-center min-h-screen text-slate-400 text-center p-4">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
            <p class="font-bold text-slate-600">æ­£åœ¨å»ºç«‹å®‰å…¨çš„å”ä½œé€£ç·š...</p>
        </div>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit } from 'firebase/firestore';
        window.FBase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // åœ–ç¤ºçµ„ä»¶
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                MapPin: "ğŸ“", Calendar: "ğŸ“…", ShoppingBag: "ğŸ›ï¸", Train: "ğŸš„",
                Info: "ğŸ“", Check: "âœ…", Copy: "ğŸ“‹", Plus: "â•",
                Trash: "ğŸ—‘ï¸", Edit: "âœï¸", Save: "ğŸ’¾", Link: "ğŸ”—", 
                Send: "âœˆï¸", Message: "ğŸ’¬", Users: "ğŸ‘¥"
            };
            return <span className={`mr-1 ${className}`} style={{fontSize: `${size}px`}}>{icons[name] || "â€¢"}</span>;
        };

        const App = () => {
            const [activeDay, setActiveDay] = useState(1);
            const [showModal, setShowModal] = useState(false);
            const [formData, setFormData] = useState({ title: '', time: '', note: '', link: '' });
            const [chatInput, setChatInput] = useState('');
            
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [syncStatus, setSyncStatus] = useState('connecting');

            const [itineraryDB, setItineraryDB] = useState({});
            const [chatMessages, setChatMessages] = useState([]);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'trip-collab-v2';

            // --- Firebase åˆå§‹åŒ–èˆ‡å¯¦æ™‚åŒæ­¥ ---
            useEffect(() => {
                let unsubItin = null;
                let unsubChat = null;

                const startSync = async () => {
                    if (!window.FBase) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, onSnapshot, setDoc, collection } = window.FBase;

                    try {
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const db = getFirestore(app);

                        // 1. èº«ä»½é©—è­‰ (Rule 3)
                        const initAuth = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                return await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                return await signInAnonymously(auth);
                            }
                        };
                        const res = await initAuth();
                        setUser(res.user);

                        // 2. å»ºç«‹æ­£ç¢ºè·¯å¾‘ (ç¬¦åˆ Firestore å¥‡å¶æ®µæ•¸è¦å‰‡)
                        // Itinerary: 6 æ®µ (doc)
                        const itinRef = doc(db, 'artifacts', appId, 'public', 'data', 'itinerary_store', 'main');
                        // Chat: 5 æ®µ (collection)
                        const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');

                        // ç›£è½è¡Œç¨‹
                        unsubItin = onSnapshot(itinRef, (snap) => {
                            if (snap.exists()) {
                                setItineraryDB(snap.data().itinerary || {});
                                setSyncStatus('online');
                            } else {
                                setDoc(itinRef, { itinerary: {}, lastUpdated: Date.now() });
                            }
                            setIsLoading(false);
                        }, (err) => {
                            console.error("Itinerary Sync Error:", err);
                            setSyncStatus('error');
                        });

                        // ç›£è½ç•™è¨€æ¿
                        unsubChat = onSnapshot(chatRef, (snap) => {
                            const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            // åœ¨å‰ç«¯é€²è¡Œæ’åºï¼Œé¿å…éœ€è¦å»ºç«‹ç´¢å¼• (Rule 2)
                            msgs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                            setChatMessages(msgs.slice(0, 20));
                        }, (err) => {
                            console.error("Chat Sync Error:", err);
                        });

                    } catch (e) {
                        console.error("Firebase Initialization Error:", e);
                    }
                };

                const wait = setInterval(() => {
                    if (window.FBase) {
                        startSync();
                        clearInterval(wait);
                    }
                }, 100);

                return () => { if(unsubItin) unsubItin(); if(unsubChat) unsubChat(); };
            }, [appId]);

            // --- é›²ç«¯å¯«å…¥æ“ä½œ ---
            const saveToCloud = async (newDB) => {
                if (!user || !window.FBase) return;
                const { getFirestore, doc, updateDoc } = window.FBase;
                const db = getFirestore();
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'itinerary_store', 'main');
                try {
                    await updateDoc(docRef, { itinerary: newDB, lastUpdated: Date.now() });
                } catch (e) { console.error("Save Error:", e); }
            };

            const sendChat = async (e) => {
                e.preventDefault();
                if (!chatInput.trim() || !user || !window.FBase) return;
                const { getFirestore, collection, addDoc } = window.FBase;
                const db = getFirestore();
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
                try {
                    await addDoc(colRef, {
                        text: chatInput,
                        uid: user.uid,
                        timestamp: Date.now()
                    });
                    setChatInput('');
                } catch (e) { console.error("Post Chat Error:", e); }
            };

            const deleteItin = (id) => {
                if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™é …è¡Œç¨‹å—ï¼Ÿæ‰€æœ‰äººçœ‹åˆ°çš„éƒ½æœƒåŒæ­¥æ¶ˆå¤±å–”ï¼')) return;
                const updated = { ...itineraryDB, [activeDay]: (itineraryDB[activeDay] || []).filter(x => x.id !== id) };
                setItineraryDB(updated);
                saveToCloud(updated);
            };

            // --- æ’åºå·¥å…· ---
            const getMinutes = (t) => {
                if (!t) return 9999;
                const m = t.match(/(\d{1,2})[:ï¼š](\d{1,2})/);
                return m ? parseInt(m[1]) * 60 + parseInt(m[2]) : 9999;
            };

            const sortedList = useMemo(() => {
                return [...(itineraryDB[activeDay] || [])].sort((a, b) => getMinutes(a.time) - getMinutes(b.time));
            }, [activeDay, itineraryDB]);

            if (isLoading) return <div className="min-h-screen flex flex-col items-center justify-center bg-white"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div><p className="font-bold text-slate-400">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p></div>;

            return (
                <div className="flex flex-col min-h-screen text-slate-800">
                    <div className="sync-badge">
                        <div className={`w-2.5 h-2.5 rounded-full ${syncStatus === 'online' ? 'bg-green-500 animate-pulse' : 'bg-red-400'}`}></div>
                        <span className="font-bold text-slate-500 uppercase tracking-tighter">{syncStatus === 'online' ? 'å¯¦æ™‚å”ä½œä¸­' : 'é€£ç·šç•°å¸¸'}</span>
                    </div>

                    <header className="bg-gradient-header text-white p-6 shadow-xl sticky top-0 z-30">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <Icon name="Users" size={24} className="text-indigo-200" />
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold tracking-tight">äº¬éƒ½æ—…ç¨‹åŒæ­¥å…±äº«ç‰ˆ</h1>
                                    <p className="text-indigo-200 text-[10px] font-bold uppercase tracking-widest opacity-60">å¤šäººå¯¦æ™‚ç·¨è¼¯èˆ‡å°è©±</p>
                                </div>
                            </div>
                        </div>
                    </header>

                    <nav className="bg-white border-b sticky top-[80px] md:top-[88px] z-20 overflow-x-auto no-scrollbar shadow-sm">
                        <div className="max-w-6xl mx-auto flex px-4">
                            {[1,2,3,4,5,6,7].map(d => (
                                <button key={d} onClick={() => setActiveDay(d)} className={`flex-none px-6 py-4 text-sm font-black transition-all border-b-4 ${activeDay === d ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>Day {d}</button>
                            ))}
                        </div>
                    </nav>

                    <main className="flex-1 max-w-6xl mx-auto w-full p-4 md:p-6 pb-24">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            
                            {/* å·¦å´ï¼šå³æ™‚è¡Œç¨‹è¡¨ */}
                            <div className="lg:col-span-8 space-y-6">
                                <section className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 fade-in">
                                    <div className="flex justify-between items-center mb-8 border-b pb-4">
                                        <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="Calendar" className="text-indigo-500" /> æ—…ä¼´å…±åŒç·¨è¼¯è¡Œç¨‹</h3>
                                        <button onClick={() => setShowModal(true)} className="bg-indigo-600 text-white px-5 py-2.5 rounded-2xl text-xs font-bold shadow-lg shadow-indigo-100 hover:scale-105 active:scale-95 transition-all flex items-center gap-1">
                                            <Icon name="Plus" /> æ–°å¢è¡Œç¨‹
                                        </button>
                                    </div>

                                    <div className="space-y-8 relative">
                                        {sortedList.map((item, i) => (
                                            <div key={item.id} className="flex gap-5 relative group">
                                                {i !== sortedList.length - 1 && <div className="absolute left-[6px] top-7 w-[2px] h-full bg-slate-50"></div>}
                                                <div className="timeline-dot mt-2 flex-shrink-0"></div>
                                                <div className="flex-1 pb-4">
                                                    <div className="flex justify-between items-baseline mb-2">
                                                        <span className="text-xs font-black text-indigo-500 w-14 bg-indigo-50 px-2 py-1 rounded-md text-center">{item.time || '--:--'}</span>
                                                        <div className="flex-1 ml-4">
                                                            <h4 className="font-bold text-lg">
                                                                {item.link ? <a href={item.link} target="_blank" className="text-indigo-600 underline underline-offset-8 hover:text-indigo-800">{item.title} ğŸ”—</a> : item.title}
                                                            </h4>
                                                            {item.note && <p className="text-sm text-slate-500 mt-2 bg-slate-50 p-3 rounded-xl border border-slate-100 inline-block font-medium">{item.note}</p>}
                                                        </div>
                                                        <button onClick={() => deleteItin(item.id)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-400 transition-all p-2">
                                                            <Icon name="Trash" size={18} />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {sortedList.length === 0 && <div className="text-center py-20 text-slate-300 font-bold italic bg-slate-50/50 rounded-3xl border-2 border-dashed border-slate-100">é€™ä¸€å¤©é‚„æ²’æœ‰å…§å®¹ï¼Œé»æ“Šæ–°å¢æŒ‰éˆ•ä¾†å…±äº«è¡Œç¨‹å§ï¼</div>}
                                    </div>
                                </section>
                            </div>

                            {/* å³å´ï¼šç•™è¨€æ¿ */}
                            <div className="lg:col-span-4 space-y-6">
                                <section className="bg-slate-900 rounded-[2.5rem] shadow-2xl flex flex-col h-[650px] overflow-hidden border border-white/10">
                                    <div className="p-6 bg-indigo-950 border-b border-white/5 flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <Icon name="Message" className="text-indigo-400" size={20} />
                                            <h3 className="text-white font-bold text-sm tracking-widest uppercase">å³æ™‚è¨è«–å€</h3>
                                        </div>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto p-5 space-y-5 no-scrollbar bg-slate-900">
                                        {chatMessages.map(m => (
                                            <div key={m.id} className={`flex flex-col ${m.uid === user?.uid ? 'items-end' : 'items-start'} fade-in`}>
                                                <div className={`px-4 py-3 max-w-[90%] text-sm font-medium chat-bubble shadow-sm ${m.uid === user?.uid ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-200'}`}>
                                                    {m.text}
                                                </div>
                                                <span className="text-[9px] text-slate-500 mt-2 uppercase font-black tracking-widest">
                                                    {m.uid === user?.uid ? 'æˆ‘' : 'æ—…ä¼´'} â€¢ {new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                </span>
                                            </div>
                                        ))}
                                        {chatMessages.length === 0 && <p className="text-center text-slate-600 text-xs mt-20 font-bold italic opacity-50">å°šç„¡è¨Šæ¯ï¼Œç™¼å€‹è¨Šæ¯è·Ÿå®¶äººè¨è«–è¡Œç¨‹å§ï¼</p>}
                                    </div>

                                    <form onSubmit={sendChat} className="p-5 bg-slate-800 border-t border-white/5 flex gap-3">
                                        <input 
                                            type="text" 
                                            value={chatInput}
                                            onChange={(e) => setChatInput(e.target.value)}
                                            placeholder="è¼¸å…¥è¨Šæ¯..."
                                            className="flex-1 bg-slate-900 border-none rounded-2xl text-white text-sm px-4 py-3 focus:ring-2 focus:ring-indigo-500 transition-all outline-none"
                                        />
                                        <button type="submit" className="bg-indigo-600 p-3 rounded-2xl text-white hover:bg-indigo-500 active:scale-90 transition-all shadow-lg shadow-indigo-900/20">
                                            <Icon name="Send" size={18} />
                                        </button>
                                    </form>
                                </section>

                                <section className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm text-center">
                                    <p className="text-[10px] text-slate-400 mb-4 font-black uppercase tracking-[0.2em]">åˆ†äº«é€£çµèˆ‡å®¶äººå”ä½œ</p>
                                    <button 
                                        onClick={() => {
                                            const el = document.createElement('textarea');
                                            el.value = window.location.href;
                                            document.body.appendChild(el);
                                            el.select();
                                            document.execCommand('copy');
                                            document.body.removeChild(el);
                                            alert('åŒæ­¥é€£çµå·²è¤‡è£½ï¼å‚³çµ¦å®¶äººæ‰“é–‹ï¼Œå¤§å®¶å°±èƒ½åœ¨ç•™è¨€æ¿èŠå¤©ï¼Œä¸¦éš¨æ™‚åŒæ­¥æ›´æ–°æ¸…å–®ã€‚');
                                        }}
                                        className="w-full py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold text-indigo-600 hover:bg-indigo-50 transition-all flex justify-center items-center gap-2 shadow-sm"
                                    >
                                        <Icon name="Link" /> è¤‡è£½å°ˆå±¬åŒæ­¥ç¶²å€
                                    </button>
                                </section>
                            </div>
                        </div>
                    </main>

                    {showModal && (
                        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl scale-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-black text-slate-800">æ–°å¢åŒæ­¥è¡Œç¨‹</h3>
                                    <button onClick={() => setShowModal(false)} className="text-slate-300 hover:text-slate-500 text-3xl">&times;</button>
                                </div>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const current = itineraryDB[activeDay] || [];
                                    const next = { ...itineraryDB, [activeDay]: [...current, { ...formData, id: Date.now().toString() }] };
                                    setItineraryDB(next);
                                    saveToCloud(next);
                                    setShowModal(false);
                                    setFormData({title:'',time:'',note:'',link:''});
                                }} className="space-y-5">
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æŠµé”æ™‚é–“ (ä¾‹å¦‚ 09:30)</label>
                                        <input type="text" value={formData.time} placeholder="14:30" onChange={e => setFormData({...formData, time: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ´»å‹•åç¨±</label>
                                        <input type="text" value={formData.title} placeholder="è¦åšä»€éº¼ï¼Ÿ" onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" required />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å‚™è¨»èªªæ˜ (é¸å¡«)</label>
                                        <input type="text" value={formData.note} placeholder="è¡Œç¨‹ç´°ç¯€..." onChange={e => setFormData({...formData, note: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é€£çµç¶²å€ (é¸å¡«)</label>
                                        <input type="url" value={formData.link} placeholder="https://..." onChange={e => setFormData({...formData, link: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    </div>
                                    <button type="submit" className="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-200 mt-4 hover:bg-indigo-700 transition-all">åŒæ­¥è‡³é›²ç«¯</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
