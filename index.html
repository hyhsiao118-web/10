<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬éƒ½ãƒ»å¤§é˜ªå†¬æ—¥æ—… - è¡Œç¨‹æ”»ç•¥ (é›²ç«¯åŒæ­¥çµ‚æ¥µç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-gradient-header { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
        .timeline-dot { width: 14px; height: 14px; border-radius: 50%; background-color: #6366f1; border: 3px solid #e0e7ff; z-index: 10; }
        .timeline-dot-custom { width: 14px; height: 14px; border-radius: 50%; background-color: #10b981; border: 3px solid #d1fae5; z-index: 10; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { opacity: 0; scale: 0.95; } to { opacity: 1; scale: 1; } }
        textarea { resize: none; overflow: hidden; }
        .clickable-link { color: #4f46e5; text-decoration: underline; text-underline-offset: 4px; transition: color 0.2s; word-break: break-all; }
        .clickable-link:hover { color: #3730a3; }
        @media print { .no-print { display: none; } body { background-color: white; } .print-only { display: block !important; } }
    </style>
</head>
<body>
    <div id="root">
        <div class="flex flex-col items-center justify-center min-h-screen text-slate-400 text-center p-4">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
            <p class="font-bold text-slate-600">æ­£åœ¨æº–å‚™æ‚¨çš„æ—…éŠåœ°åœ–...</p>
            <p class="text-xs mt-2">é¦–æ¬¡é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å°‡ Firebase å·¥å…·æ›è¼‰åˆ° windowï¼Œä¾›ä¸‹æ–¹ Babel è…³æœ¬ä½¿ç”¨
        window.FirebaseModular = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, 
            onAuthStateChanged, getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // åœ–ç¤ºçµ„ä»¶
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                MapPin: "ğŸ“", Calendar: "ğŸ“…", ShoppingBag: "ğŸ›ï¸", Train: "ğŸš„",
                Info: "ğŸ“", Check: "âœ…", Copy: "ğŸ“‹", Plus: "â•",
                CloudSnow: "â„ï¸", Navigation: "ğŸ§­", Car: "ğŸš—", Camera: "ğŸ“·",
                Trash: "ğŸ—‘ï¸", Edit: "âœï¸", Save: "ğŸ’¾", Link: "ğŸ”—", List: "ğŸ“œ", Cloud: "â˜ï¸"
            };
            return <span className={`mr-1 ${className}`} style={{fontSize: `${size}px`}}>{icons[name] || "â€¢"}</span>;
        };

        const App = () => {
            const [activeDay, setActiveDay] = useState(1);
            const [copied, setCopied] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [modalType, setModalType] = useState('itinerary'); 
            const [formData, setFormData] = useState({ title: '', time: '', note: '', link: '', desc: '' });
            
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            // è³‡æ–™åº«ç‹€æ…‹
            const [itineraryDB, setItineraryDB] = useState({});
            const [shoppingDB, setShoppingDB] = useState({});
            const [statusData, setStatusData] = useState({ temp: "2Â°C - 9Â°C", transport: "ICOCA / JR Pass", misc: "é›²ç«¯é€£ç·šæ­£å¸¸" });
            const [dailyNotes, setDailyNotes] = useState({});

            const defaultItinerary = {
                1: [
                    { id: 'd1-1', time: '08:05', title: 'æ¡ƒåœ’æ©Ÿå ´èµ·é£› (CI156)', note: '5:00 æ´¾è»Šå‡ºç™¼', isDefault: true },
                    { id: 'd1-2', time: '11:35', title: 'æŠµé”é—œè¥¿æ©Ÿå ´ T1', note: 'å¾ C å‡ºå£æ­åˆ©æœ¨æ´¥å·´å£«', isDefault: true },
                    { id: 'd1-3', time: '14:00', title: 'äº¬éƒ½è»Šç«™ç”¨é¤', note: 'æ¨è–¦æ‹‰éºµå°è·¯', link: 'https://www.kyoto-ramen-koji.com/', isDefault: true },
                    { id: 'd1-4', time: '15:00', title: 'ç´ å±…æ—…èˆ Check-in', note: 'æ­¥è¡Œ10åˆ†é˜å¯é”æ¸…æ°´å¯º', link: 'https://guesthousesoi.com/rooms-tw/', isDefault: true }
                ],
                2: [
                    { id: 'd2-1', time: '09:00', title: 'ä¼è¦‹æ¡ƒå±±è€è¡—', note: 'é…’è—å·¡ç¦®', isDefault: true },
                    { id: 'd2-2', time: '11:00', title: 'ä¼è¦‹åçŸ³èˆŸ', note: 'æ­èˆ¹æ•£ç­–', link: 'https://fushimi-ykk.com/jikkokubune/', isDefault: true },
                    { id: 'd2-3', time: '14:00', title: 'å®‡æ²»å¹³ç­‰é™¢', note: 'é«”é©—æ­£å®—æŠ¹èŒ¶', link: 'https://www.byodoin.or.jp/', isDefault: true }
                ],
                3: [
                    { id: 'd3-1', time: '09:30', title: 'å–è»Šï¼šæ¸…æ°´å¯ºé™„è¿‘', note: 'æº–å‚™å¥½é–‹å§‹å–®è»Šè¡Œ', link: 'https://www.hellocycling.jp/', isDefault: true },
                    { id: 'd3-2', time: '11:00', title: 'å…«å‚ç¥ç¤¾ & ç¥‡åœ’', note: 'ç©¿æ¢­å¤æ„è¡—å¼„', isDefault: true },
                    { id: 'd3-3', time: '14:00', title: 'é´¨å·å¹³å¦æ²³å²¸', note: 'é¨è»Šæœ€èˆ’æœçš„åœ°æ®µ', isDefault: true },
                    { id: 'd3-4', time: '17:30', title: 'æ²³åŸç”ºé‚„è»Š', note: 'æ™šé¤äº«å—äº¬æ–™ç†', isDefault: true }
                ],
                4: [
                    { id: 'd4-1', time: '08:30', title: 'ç§Ÿè»Šå‡ºç™¼', note: 'ç¢ºèªé…å‚™é›ªèƒ', isDefault: true },
                    { id: 'd4-2', time: '11:30', title: 'ç¾å±±èŒ…è‘ºä¹‹é‡Œ', note: 'é€ è¨ªçµ•ç¾é›ªåœ°åˆæŒå±‹', link: 'https://miyamanavi.com/zh/sightseeing/kayabuki-no-sato', isDefault: true },
                    { id: 'd4-3', time: '15:00', title: 'ç¾å±±æ°‘å®¿å…¥ä½', note: 'é«”é©—å±±é–“å¯§éœ', isDefault: true }
                ],
                5: [
                    { id: 'd5-1', time: '10:00', title: 'åµå±±æ¸¡æœˆæ©‹', note: 'ç«¹æ—å°å¾‘èˆ‡æ‹ç…§', isDefault: true },
                    { id: 'd5-2', time: '16:00', title: 'æ­¸é‚„ç§Ÿè»Š', note: 'äº¬éƒ½è»Šç«™å‘¨é‚Šé‚„è»Š', isDefault: true },
                    { id: 'd5-3', time: '18:00', title: 'å‰å¾€å¤§é˜ªé£¯åº—', note: 'æº–å‚™é€²å…¥ç¾é£Ÿä¹‹éƒ½', isDefault: true }
                ],
                6: [
                    { id: 'd6-1', time: '08:30', title: 'æ–°å¤§é˜ªå‡ºç™¼', note: 'æ­ä¹˜æ–°å¹¹ç·šå‰å¾€å§¬è·¯', isDefault: true },
                    { id: 'd6-2', time: '10:00', title: 'ç™»ä¸Šå§¬è·¯åŸ', note: 'ä¿¯ç°æ•´å€‹åŸå¸‚ç¾æ™¯', link: 'https://www.himejicastle.jp/cn/', isDefault: true },
                    { id: 'd6-3', time: '18:00', title: 'å¿ƒé½‹æ©‹ç­‹', note: 'æ„Ÿå—å¤§é˜ªç†±é¬§å¤œç”Ÿæ´»', isDefault: true }
                ],
                7: [
                    { id: 'd7-1', time: '11:00', title: 'æŠµé” Rinku Town', note: 'æœ€å¾Œæ¡è²·æˆ°å ´', link: 'https://www.premiumoutlets.co.jp/rinkutown/', isDefault: true },
                    { id: 'd7-2', time: '14:00', title: 'Rinku Outlet', note: 'åœ‹éš›å“ç‰Œæœ€å¾ŒæŠ˜æ‰£', isDefault: true },
                    { id: 'd7-3', time: '17:00', title: 'é—œè¥¿æ©Ÿå ´å ±åˆ°', note: 'æº–å‚™è¿”èˆª', isDefault: true }
                ]
            };

            const defaultShopping = {
                1: [{ id: 's1-1', title: 'Porta åœ°ä¸‹è¡—', desc: 'æµè¡Œæœé£¾èˆ‡è—¥å¦', link: 'https://www.yodobashi.com/ec/store/0033/', isDefault: true }],
                2: [{ id: 's2-1', title: 'ä¸­æ‘è—¤å‰æŠ¹èŒ¶', desc: 'å¿…è²·æŠ¹èŒ¶ç”œé»', link: 'https://tokichi.jp/zh-TW/', isDefault: true }]
            };

            // --- Firebase åˆå§‹åŒ–èˆ‡æˆæ¬Š ---
            useEffect(() => {
                if (!window.FirebaseModular) return;
                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FirebaseModular;

                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);

                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Auth Failure:", e);
                            setError("èº«ä»½é©—è­‰å¤±æ•—ã€‚");
                        }
                    };
                    initAuth();

                    const unsubscribe = onAuthStateChanged(auth, setUser);
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    setError("Firebase åˆå§‹åŒ–å¤±æ•—ã€‚");
                }
            }, []);

            // --- è³‡æ–™ç›£è½èˆ‡åŒæ­¥ ---
            useEffect(() => {
                if (!user || !window.FirebaseModular) return;
                const { getFirestore, doc, onSnapshot, setDoc } = window.FirebaseModular;
                const db = getFirestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'kyoto-trip-v4';
                
                // ä¿®æ­£è·¯å¾‘ï¼šä½¿ç”¨ 6 æ®µå¶æ•¸è·¯å¾‘ä»¥ç¬¦åˆ doc() è¦æ±‚
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trip_itinerary', 'shared_data');
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setItineraryDB(data.itinerary || {});
                        setShoppingDB(data.shopping || {});
                        setStatusData(data.status || { temp: "2Â°C - 9Â°C", transport: "ICOCA / JR Pass", misc: "é›²ç«¯å·²åŒæ­¥" });
                        setDailyNotes(data.notes || {});
                    } else {
                        // åˆå§‹åŒ–è³‡æ–™è‡³é›²ç«¯
                        setDoc(docRef, {
                            itinerary: defaultItinerary,
                            shopping: defaultShopping,
                            status: { temp: "2Â°C - 9Â°C", transport: "ICOCA / JR Pass", misc: "é›²ç«¯è‡ªå‹•å»ºç«‹æˆåŠŸ" },
                            notes: {},
                            lastUpdated: new Date().toISOString()
                        });
                    }
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Listen Error:", err);
                    setError("ç„¡æ³•é€£æ¥åˆ°é›²ç«¯è³‡æ–™ã€‚");
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // --- å„²å­˜è‡³é›²ç«¯ ---
            const saveToCloud = useCallback(async (updates) => {
                if (!user || !window.FirebaseModular) return;
                const { getFirestore, doc, updateDoc } = window.FirebaseModular;
                const db = getFirestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'kyoto-trip-v4';
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trip_itinerary', 'shared_data');
                
                try {
                    await updateDoc(docRef, {
                        ...updates,
                        lastUpdated: new Date().toISOString()
                    });
                } catch (e) {
                    console.error("Cloud Update Failed:", e);
                }
            }, [user]);

            // --- æ’åº ---
            const getMinutes = (timeStr) => {
                if (!timeStr) return 9999;
                const match = timeStr.match(/(\d{1,2})[:ï¼š](\d{1,2})/);
                return match ? parseInt(match[1]) * 60 + parseInt(match[2]) : 9999;
            };

            const sortedItinerary = useMemo(() => {
                return [...(itineraryDB[activeDay] || [])].sort((a, b) => getMinutes(a.time) - getMinutes(b.time));
            }, [activeDay, itineraryDB]);

            // --- åŒ¯å‡ºåŠŸèƒ½ ---
            const generateFullText = () => {
                let text = "âœˆï¸ äº¬éƒ½ãƒ»å¤§é˜ªå†¬æ—¥æ—…è¡Œç¨‹ç¸½è¦½ âœˆï¸\n\n";
                text += `ğŸŒ¡ï¸ æ°£æº«ï¼š${statusData.temp}\nğŸš„ äº¤é€šï¼š${statusData.transport}\nğŸ“Œ å‚™è¨»ï¼š${statusData.misc}\n\n`;
                for (let d = 1; d <= 7; d++) {
                    const dates = ["", "2/8 (æ—¥)", "2/9 (ä¸€)", "2/10 (äºŒ)", "2/11 (ä¸‰)", "2/12 (å››)", "2/13 (äº”)", "2/14 (å…­)"];
                    text += `ã€Day ${d} | ${dates[d]}ã€‘\n`;
                    const dayItin = [...(itineraryDB[d] || [])].sort((a,b) => getMinutes(a.time) - getMinutes(b.time));
                    dayItin.forEach(i => text += `  â° ${i.time || '--:--'} ${i.title}\n`);
                    const note = dailyNotes[d];
                    if (note) text += `  ğŸ“ å‚™è¨»: ${note}\n`;
                    text += "\n";
                }
                return text;
            };

            const copyFullList = () => {
                const el = document.createElement('textarea');
                el.value = generateFullText();
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            // --- å½ˆçª—è™•ç† ---
            const openModal = (type, item = null) => {
                setModalType(type);
                if (item) {
                    setEditingItem(item);
                    setFormData({ title: item.title || '', time: item.time || '', note: item.note || '', link: item.link || '', desc: item.desc || '' });
                } else {
                    setEditingItem(null);
                    setFormData({ title: '', time: '', note: '', link: '', desc: '' });
                }
                setShowModal(true);
            };

            const handleSaveForm = (e) => {
                e.preventDefault();
                const dbKey = modalType === 'itinerary' ? 'itinerary' : 'shopping';
                const currentData = modalType === 'itinerary' ? itineraryDB : shoppingDB;
                const currentList = currentData[activeDay] || [];
                
                let newList;
                if (editingItem) {
                    newList = currentList.map(item => item.id === editingItem.id ? { ...item, ...formData } : item);
                } else {
                    newList = [...currentList, { ...formData, id: Date.now().toString(), isDefault: false }];
                }

                saveToCloud({ [dbKey]: { ...currentData, [activeDay]: newList } });
                setShowModal(false);
            };

            const handleDelete = (id) => {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
                const dbKey = modalType === 'itinerary' ? 'itinerary' : 'shopping';
                const currentData = modalType === 'itinerary' ? itineraryDB : shoppingDB;
                const updatedList = currentData[activeDay].filter(item => item.id !== id);
                saveToCloud({ [dbKey]: { ...currentData, [activeDay]: updatedList } });
                setShowModal(false);
            };

            if (error) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen text-rose-500 p-8 text-center">
                        <h2 className="text-xl font-bold mb-2">é€£ç·šç™¼ç”ŸéŒ¯èª¤</h2>
                        <p>{error}</p>
                        <button onClick={() => location.reload()} className="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-xl">é‡è©¦</button>
                    </div>
                );
            }

            if (isLoading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen text-slate-400">
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                        <p className="font-bold">åŒæ­¥é›²ç«¯è¡Œç¨‹ä¸­...</p>
                    </div>
                );
            }

            return (
                <div className="flex flex-col min-h-screen text-slate-800">
                    <header className="bg-gradient-header text-white p-6 shadow-xl sticky top-0 z-30 no-print">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-white/10 p-2 rounded-xl backdrop-blur-md border border-white/20">
                                    <Icon name="Cloud" size={24} className="text-indigo-200" />
                                </div>
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold tracking-tight">äº¬éƒ½ãƒ»å¤§é˜ªå†¬æ—¥æ—…</h1>
                                    <p className="text-indigo-200 text-[10px] font-medium uppercase tracking-widest">å¤šäººå¯¦æ™‚åŒæ­¥åœ°åœ–</p>
                                </div>
                            </div>
                            <button onClick={() => setShowExportModal(true)} className="bg-white text-indigo-900 px-4 py-2 rounded-xl text-xs font-black shadow-lg hover:bg-indigo-50 transition-all flex items-center gap-1">
                                <Icon name="List" /> åŒ¯å‡ºæ¸…å–®
                            </button>
                        </div>
                    </header>

                    <nav className="bg-white border-b sticky top-[80px] md:top-[88px] z-20 overflow-x-auto no-scrollbar shadow-sm no-print">
                        <div className="max-w-4xl mx-auto flex px-4">
                            {[1,2,3,4,5,6,7].map(d => (
                                <button key={d} onClick={() => setActiveDay(d)} className={`flex-none px-6 py-4 text-sm font-black transition-all border-b-4 ${activeDay === d ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                    Day {d}
                                </button>
                            ))}
                        </div>
                    </nav>

                    <main className="flex-1 max-w-4xl mx-auto w-full p-4 md:p-6 pb-24 space-y-6 fade-in no-print">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <div className="lg:col-span-2 space-y-6">
                                <section className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-6">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center">
                                                <Icon name="Calendar" /> è¡Œç¨‹åœ°åœ– (è‡ªå‹•æ’åº)
                                            </h3>
                                            <button onClick={() => openModal('itinerary')} className="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-indigo-100 flex items-center">
                                                <Icon name="Plus" /> æ–°å¢è¡Œç¨‹
                                            </button>
                                        </div>

                                        <div className="space-y-6 relative">
                                            {sortedItinerary.map((item, i) => (
                                                <div key={item.id} className="flex gap-4 relative fade-in group cursor-pointer" onClick={() => openModal('itinerary', item)}>
                                                    {i !== sortedItinerary.length - 1 && <div className="absolute left-[6px] top-6 w-[2px] h-full bg-slate-100"></div>}
                                                    <div className={`${item.isDefault ? 'timeline-dot' : 'timeline-dot-custom'} mt-1.5 flex-shrink-0`}></div>
                                                    <div className="flex-1 pb-4">
                                                        <div className="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
                                                            <span className={`text-xs font-black ${item.isDefault ? 'text-indigo-500' : 'text-emerald-600'} md:w-16`}>{item.time || 'æœªå®šæ™‚'}</span>
                                                            <div className="flex justify-between items-center flex-1">
                                                                <h4 className="font-bold text-lg">
                                                                    {item.link ? (
                                                                        <a href={item.link} target="_blank" rel="noopener noreferrer" className="clickable-link" onClick={(e) => e.stopPropagation()}>{item.title} <Icon name="Link" size={14} className="opacity-60" /></a>
                                                                    ) : item.title}
                                                                </h4>
                                                                <div className="opacity-0 group-hover:opacity-100 text-slate-300 text-[10px] font-bold">âœï¸ ç·¨è¼¯</div>
                                                            </div>
                                                        </div>
                                                        {item.note && <p className="text-sm p-3 rounded-2xl border bg-slate-50 border-slate-100 mt-2 text-slate-600 leading-relaxed font-medium">{item.note}</p>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </section>

                                <section className="bg-amber-50 rounded-3xl p-6 border border-amber-200 space-y-3">
                                    <h4 className="font-bold text-amber-900 text-sm flex items-center"><Icon name="Info" /> ç•¶æ—¥ç§æˆ¿ç­†è¨˜</h4>
                                    <textarea 
                                        className="w-full bg-transparent border-none focus:ring-0 text-amber-800 text-sm font-medium min-h-[100px]"
                                        placeholder="åœ¨é€™è£¡å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…..."
                                        value={dailyNotes[activeDay] || ''}
                                        onChange={(e) => {
                                            const newNotes = {...dailyNotes, [activeDay]: e.target.value};
                                            setDailyNotes(newNotes);
                                            saveToCloud({ notes: newNotes });
                                        }}
                                    ></textarea>
                                </section>
                            </div>

                            <div className="space-y-6">
                                <section className="bg-white rounded-3xl shadow-sm p-6 border border-slate-200">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="flex items-center gap-2 text-rose-500 font-black text-sm uppercase tracking-wider"><Icon name="ShoppingBag" /> è³¼ç‰©æ¸…å–®</div>
                                        <button onClick={() => openModal('shopping')} className="text-rose-400 hover:text-rose-600"><Icon name="Plus" /></button>
                                    </div>
                                    <div className="space-y-3">
                                        {(shoppingDB[activeDay] || []).map((shop) => (
                                            <div key={shop.id} onClick={() => openModal('shopping', shop)} className="p-4 rounded-2xl border border-slate-100 bg-slate-50 hover:bg-rose-50 cursor-pointer group transition-all">
                                                <div className="font-bold text-slate-800 text-sm">
                                                    {shop.link ? <a href={shop.link} target="_blank" rel="noopener noreferrer" className="clickable-link" onClick={(e) => e.stopPropagation()}>{shop.title} <Icon name="Link" size={12} /></a> : shop.title}
                                                </div>
                                                {shop.desc && <div className="text-[10px] text-slate-400 mt-1">{shop.desc}</div>}
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                <section className="bg-slate-900 rounded-3xl p-6 text-white shadow-xl">
                                    <h3 className="font-bold text-[10px] text-indigo-300 uppercase tracking-widest mb-5 text-center">ç‹€æ…‹å„€è¡¨æ¿ (å¤šäººåŒæ­¥)</h3>
                                    <div className="space-y-5">
                                        {['temp', 'transport', 'misc'].map(key => (
                                            <div key={key} className="flex items-center gap-4 group">
                                                <div className="text-2xl bg-white/10 p-2 rounded-xl font-bold">
                                                    {key === 'temp' ? 'ğŸŒ¡ï¸' : key === 'transport' ? 'ğŸš„' : 'ğŸ“Œ'}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="text-[10px] opacity-50 font-bold uppercase tracking-tighter">{key === 'temp' ? 'æ°£æº«' : key === 'transport' ? 'äº¤é€š' : 'ç‰¹åˆ¥æé†’'}</div>
                                                    <input 
                                                        className="w-full bg-transparent border-none p-0 text-sm font-black focus:ring-0 text-white" 
                                                        value={statusData[key] || ''} 
                                                        onChange={(e) => {
                                                            const newStatus = {...statusData, [key]: e.target.value};
                                                            setStatusData(newStatus);
                                                            saveToCloud({ status: newStatus });
                                                        }} 
                                                    />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        </div>
                    </main>

                    {/* Modal */}
                    {showModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl scale-in">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold flex items-center"><Icon name={editingItem ? "Edit" : "Plus"} /> {editingItem ? 'ç·¨è¼¯' : 'æ–°å¢'}å…§å®¹</h3>
                                    {editingItem && <button onClick={() => handleDelete(editingItem.id)} className="text-slate-300 hover:text-red-500"><Icon name="Trash" size={20} /></button>}
                                </div>
                                <form onSubmit={handleSaveForm} className="space-y-4">
                                    {modalType === 'itinerary' && <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">æ™‚é–“ (09:30)</label><input type="text" value={formData.time} placeholder="14:30" onChange={e => setFormData({...formData, time: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" /></div>}
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">åç¨± / å…§å®¹</label><input type="text" value={formData.title} placeholder="è¦åšä»€éº¼ï¼Ÿ" onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" required /></div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">ç¶²å€é€£çµ</label><input type="url" value={formData.link} placeholder="https://..." onChange={e => setFormData({...formData, link: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">å‚™è¨»</label><input type="text" value={formData.note || formData.desc} placeholder="è£œå……èªªæ˜..." onChange={e => setFormData({...formData, note: e.target.value, desc: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                                    <div className="flex gap-2 pt-2"><button type="button" onClick={() => setShowModal(false)} className="flex-1 p-3 font-bold text-slate-500">å–æ¶ˆ</button><button type="submit" className={`flex-1 p-3 text-white font-bold rounded-2xl shadow-lg ${modalType === 'itinerary' ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-rose-500 hover:bg-rose-600'}`}>å„²å­˜ä¸¦åŒæ­¥</button></div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showExportModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] shadow-2xl scale-in overflow-hidden flex flex-col">
                                <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                                    <h3 className="text-xl font-bold flex items-center gap-2">å…¨è¡Œç¨‹åŒ¯å‡ºæ¸…å–®</h3>
                                    <button onClick={() => setShowExportModal(false)} className="text-slate-400 text-2xl font-bold">&times;</button>
                                </div>
                                <div className="flex-1 p-6 overflow-y-auto whitespace-pre-wrap font-mono text-sm leading-relaxed bg-white">
                                    {generateFullText()}
                                </div>
                                <div className="p-6 border-t bg-slate-50 flex gap-3">
                                    <button onClick={copyFullList} className={`flex-1 p-3 rounded-2xl font-bold transition-all ${copied ? 'bg-emerald-500' : 'bg-indigo-600'} text-white shadow-lg`}>
                                        {copied ? 'âœ… å·²æˆåŠŸè¤‡è£½ï¼' : 'ğŸ“‹ ä¸€éµè¤‡è£½æ–‡å­—è¡Œç¨‹'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="bg-white border-t p-6 text-center text-slate-400 text-[10px] font-bold uppercase tracking-widest no-print">
                        KYOTO & OSAKA Winter Adventure 2026
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>