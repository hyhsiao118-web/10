<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬éƒ½æ—…ç¨‹ - é ç´„èˆ‡å»ºè­°ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .bg-gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .admin-glow { border: 2px solid #6366f1; box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK (Modular) -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, getDocs } from 'firebase/firestore';
        window.FCloud = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, getDocs };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // åœ–ç¤ºçµ„ä»¶
        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                MapPin: "ğŸ“", Calendar: "ğŸ“…", ShoppingBag: "ğŸ›ï¸", Info: "ğŸ“",
                Check: "âœ…", Plus: "â•", Trash: "ğŸ—‘ï¸", Box: "ğŸ“¦",
                User: "ğŸ‘¤", Clock: "â°", Rocket: "ğŸš€", Shield: "ğŸ”’"
            };
            return <span className={className} style={{fontSize: `${size}px`}}>{icons[name] || "â€¢"}</span>;
        };

        const App = () => {
            const [view, setView] = useState('user'); // 'user' or 'admin'
            const [activeDay, setActiveDay] = useState(1);
            const [orders, setOrders] = useState([]);
            const [formData, setFormData] = useState({ title: '', note: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'trip-order-v1';

            // --- Firebase é€£ç·š ---
            useEffect(() => {
                const init = async () => {
                    if (!window.FCloud) return;
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, collection, onSnapshot } = window.FCloud;
                    
                    try {
                        const config = JSON.parse(__firebase_config);
                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const db = getFirestore(app);

                        // ç™»å…¥
                        const authRes = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token)
                            ? await signInWithCustomToken(auth, __initial_auth_token)
                            : await signInAnonymously(auth);
                        setUser(authRes.user);

                        // ç›£è½å¾Œå°è¨‚å–® (5æ®µè·¯å¾‘ç¬¦åˆè¦å‰‡)
                        const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                        const unsub = onSnapshot(ordersRef, (snap) => {
                            const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            data.sort((a, b) => b.timestamp - a.timestamp);
                            setOrders(data);
                            setIsLoading(false);
                        });

                        return () => unsub();
                    } catch (e) { console.error(e); }
                };
                
                const timer = setInterval(() => { if(window.FCloud) { init(); clearInterval(timer); } }, 100);
            }, [appId]);

            // --- å‰å°æäº¤åŠŸèƒ½ (åƒä¸‹å–®ä¸€æ¨£) ---
            const handleSubmitOrder = async (e) => {
                e.preventDefault();
                if (!formData.title || !user) return;
                setIsSubmitting(true);

                const { getFirestore, collection, addDoc } = window.FCloud;
                const db = getFirestore();
                const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');

                try {
                    await addDoc(ordersRef, {
                        day: activeDay,
                        title: formData.title,
                        note: formData.note,
                        userId: user.uid.substring(0, 5), // åŒ¿å ID
                        timestamp: Date.now(),
                        status: 'pending'
                    });
                    setFormData({ title: '', note: '' });
                    alert('âœ… å»ºè­°å·²å‚³é€åˆ°ç®¡ç†å“¡å¾Œå°ï¼');
                } catch (e) { alert('å‚³é€å¤±æ•—'); }
                setIsSubmitting(false);
            };

            const deleteOrder = async (id) => {
                const { getFirestore, doc, deleteDoc } = window.FCloud;
                const db = getFirestore();
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
            };

            if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-white text-slate-400 font-bold animate-pulse">æ­£åœ¨é–‹å•Ÿç³»çµ±...</div>;

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-gradient-header text-white p-6 shadow-xl sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <Icon name="Rocket" size={24} className="text-indigo-400" />
                                <div>
                                    <h1 className="text-xl font-bold">äº¬éƒ½ãƒ»å¤§é˜ªæ—…ç¨‹ç®¡ç†</h1>
                                    <p className="text-slate-400 text-[10px] uppercase tracking-widest font-bold">Request & Management System</p>
                                </div>
                            </div>
                            <div className="flex bg-slate-800 p-1 rounded-xl">
                                <button onClick={() => setView('user')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${view === 'user' ? 'bg-white text-slate-900 shadow-md' : 'text-slate-400'}`}>å‰å° (å¡«å¯«)</button>
                                <button onClick={() => setView('admin')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${view === 'admin' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-400'}`}>å¾Œå° (ç®¡ç†)</button>
                            </div>
                        </div>
                    </header>

                    {view === 'user' ? (
                        /* --- å‰å°ä½¿ç”¨è€…ä»‹é¢ --- */
                        <main className="flex-1 max-w-6xl mx-auto w-full p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 fade-in">
                            <div className="lg:col-span-7 space-y-6">
                                <section className="bg-white rounded-3xl p-8 border border-slate-200 card-shadow">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-black text-slate-800">Day {activeDay} è¡Œç¨‹ç¸½è¦½</h2>
                                        <div className="flex gap-2">
                                            {[1,2,3,4,5,6,7].map(d => (
                                                <button key={d} onClick={() => setActiveDay(d)} className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${activeDay === d ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{d}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="p-10 border-2 border-dashed border-slate-100 rounded-3xl text-center">
                                        <p className="text-slate-400 font-medium italic">é€™è£¡é¡¯ç¤ºä¸»è¡Œç¨‹å…§å®¹...<br/><span className="text-xs font-bold opacity-60">ä½¿ç”¨å³å´è¡¨å–®æäº¤è®Šæ›´å»ºè­°çµ¦ç®¡ç†å“¡ã€‚</span></p>
                                    </div>
                                </section>
                            </div>

                            <div className="lg:col-span-5">
                                <section className="bg-white rounded-3xl p-8 border border-slate-200 card-shadow sticky top-32">
                                    <div className="flex items-center gap-2 mb-6 text-indigo-600 font-black uppercase text-xs tracking-wider">
                                        <Icon name="Box" size={20} /> æäº¤å»ºè­°èˆ‡è®Šæ›´ (è¨‚å–®æ¨¡å¼)
                                    </div>
                                    <form onSubmit={handleSubmitOrder} className="space-y-5">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å»ºè­°åœ°é» / å…§å®¹</label>
                                            <input 
                                                type="text" 
                                                value={formData.title} 
                                                onChange={e => setFormData({...formData, title: e.target.value})}
                                                placeholder="ä¾‹å¦‚ï¼šæƒ³å»é€™é–“å’–å•¡å»³ã€æŠŠé›†åˆæ”¹åˆ° 10:00"
                                                className="w-full p-4 bg-slate-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è©³ç´°å‚™è¨» (é¸å¡«)</label>
                                            <textarea 
                                                rows="3"
                                                value={formData.note}
                                                onChange={e => setFormData({...formData, note: e.target.value})}
                                                placeholder="è«‹èªªæ˜åŸå› æˆ–è²¼ä¸Šç¶²å€..."
                                                className="w-full p-4 bg-slate-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none"
                                            ></textarea>
                                        </div>
                                        <button 
                                            type="submit" 
                                            disabled={isSubmitting}
                                            className="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-xl hover:bg-slate-800 active:scale-95 transition-all flex justify-center items-center gap-2"
                                        >
                                            {isSubmitting ? 'æ­£åœ¨å‚³é€...' : <><Icon name="Send" /> å‚³é€è‡³å¾Œå°</>}
                                        </button>
                                        <p className="text-[10px] text-slate-400 text-center font-bold">é»æ“Šå‚³é€å¾Œï¼Œç®¡ç†å“¡æœƒåœ¨å…¶å„€è¡¨æ¿å³æ™‚çœ‹è¦‹æ‚¨çš„éœ€æ±‚ã€‚</p>
                                    </form>
                                </section>
                            </div>
                        </main>
                    ) : (
                        /* --- å¾Œå°ç®¡ç†å“¡å„€è¡¨æ¿ --- */
                        <main className="flex-1 max-w-6xl mx-auto w-full p-6 fade-in">
                            <div className="bg-white rounded-3xl border-2 admin-glow overflow-hidden">
                                <div className="p-8 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                                    <div>
                                        <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2">
                                            <Icon name="Shield" className="text-indigo-600" /> ç®¡ç†å“¡å¾Œå°
                                        </h2>
                                        <p className="text-slate-500 text-xs mt-1">ç›®å‰å…±æœ‰ {orders.length} ç­†ä¾†è‡ªå‰å°çš„æäº¤</p>
                                    </div>
                                    <div className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold">å³æ™‚åŒæ­¥ä¸­</div>
                                </div>

                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead>
                                            <tr className="text-slate-400 text-[10px] uppercase font-black border-b border-slate-100">
                                                <th className="px-8 py-4">æ™‚é–“è»¸ / ä½¿ç”¨è€…</th>
                                                <th className="px-8 py-4">å¤©æ•¸</th>
                                                <th className="px-8 py-4">å»ºè­°å…§å®¹</th>
                                                <th className="px-8 py-4">è©³ç´°å‚™è¨»</th>
                                                <th className="px-8 py-4 text-right">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {orders.map(order => (
                                                <tr key={order.id} className="hover:bg-slate-50/50 transition-all">
                                                    <td className="px-8 py-6">
                                                        <div className="font-bold text-slate-800 text-sm">USER-{order.userId}</div>
                                                        <div className="text-[10px] text-slate-400">{new Date(order.timestamp).toLocaleString()}</div>
                                                    </td>
                                                    <td className="px-8 py-6 text-sm font-black text-indigo-600">Day {order.day}</td>
                                                    <td className="px-8 py-6 text-sm font-bold text-slate-700">{order.title}</td>
                                                    <td className="px-8 py-6 text-xs text-slate-500 max-w-xs">{order.note || 'ç„¡'}</td>
                                                    <td className="px-8 py-6 text-right">
                                                        <button 
                                                            onClick={() => deleteOrder(order.id)}
                                                            className="p-2 text-slate-300 hover:text-red-500 transition-all"
                                                            title="åˆªé™¤æ­¤ç´€éŒ„"
                                                        >
                                                            <Icon name="Trash" size={18} />
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {orders.length === 0 && (
                                                <tr>
                                                    <td colSpan="5" className="px-8 py-20 text-center text-slate-300 font-bold italic">ç›®å‰å°šç„¡ä»»ä½•æäº¤ç´€éŒ„</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </main>
                    )}

                    <footer className="bg-white border-t p-6 text-center text-slate-400 text-[10px] font-bold uppercase tracking-widest">
                        Collaborative Itinerary System Â© 2026
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
